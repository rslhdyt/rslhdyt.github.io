<!DOCTYPE html> <html lang="en" class="h-full"> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LTH48DE8D"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-2LTH48DE8D'); </script> <meta charset="utf-8"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=author content="Risal Hidayat"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Setting Resource Limits in Kamal 2 | Risal Hidayat</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Setting Resource Limits in Kamal 2" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Learn how to set CPU and memory limits in Kamal 2 for multi-app deployments. Step-by-step guide for configuring resource constraints in application, accessory, and proxy containers." /> <meta property="og:description" content="Learn how to set CPU and memory limits in Kamal 2 for multi-app deployments. Step-by-step guide for configuring resource constraints in application, accessory, and proxy containers." /> <link rel="canonical" href="https://rslhdyt.dev/setting-resource-limits-in-kamal-2/" /> <meta property="og:url" content="https://rslhdyt.dev/setting-resource-limits-in-kamal-2/" /> <meta property="og:site_name" content="Risal Hidayat" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-10-24T17:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Setting Resource Limits in Kamal 2" /> <meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-24T17:00:00+00:00","datePublished":"2024-10-24T17:00:00+00:00","description":"Learn how to set CPU and memory limits in Kamal 2 for multi-app deployments. Step-by-step guide for configuring resource constraints in application, accessory, and proxy containers.","headline":"Setting Resource Limits in Kamal 2","mainEntityOfPage":{"@type":"WebPage","@id":"https://rslhdyt.dev/setting-resource-limits-in-kamal-2/"},"url":"https://rslhdyt.dev/setting-resource-limits-in-kamal-2/"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon" sizes="180x180" href="https://rslhdyt.dev/assets/images/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="https://rslhdyt.dev/assets/images/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="https://rslhdyt.dev/assets/images/favicon/favicon-16x16.png"> <link rel="manifest" href="https://rslhdyt.dev/site.webmanifest"> <link rel="alternate" type="application/rss+xml" title="Risal Hidayat" href="https://rslhdyt.dev/feed.xml" /> <script src="https://kit.fontawesome.com/d9b09040a7.js" crossorigin="anonymous"></script> <!-- highlight.js --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css" integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script> <script>hljs.highlightAll();</script> <link rel="stylesheet" href="/assets/css/main.css"> </head> <body class="bg-zinc-50 flex h-full"> <div class="max-w-[600px] flex flex-col mx-auto w-11/12"> <nav class=" mt-7 md:mt-10 mb-10"> <ul class="flex flex-row justify-center space-x-6 text-l text-gray-500"> <li> <a href="https://rslhdyt.dev/">Home</a> </li> <li> <a href="https://rslhdyt.dev/blog">Blog</a> </li> <li class="item hidden sm:block"> <a href="https://rslhdyt.dev/code_snippet">Code Snippet</a> </li> <li> <a href="https://rslhdyt.dev/projects">Projects</a> </li> <li> <a href="https://rslhdyt.dev/about">About</a> </li> </ul> </nav> <h1 class="text-3xl text-center tracking-tight font-bold mb-5">Setting Resource Limits in Kamal 2</h1> <span class="block text-center mb-5"> <time datetime="24-10-2024">Thursday. October 24, 2024</time> - <span class="reading-time" title="Estimated read time"> 1 min read </span> </span> <div class="flex flex-row space-x-1.5 justify-center mb-10"> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/docker">docker</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/rails">rails</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/kamal">kamal</a> </div> <div class="posts"> <p>One of the most requested features in Kamal 2 is the ability to easily deploy multiple applications on a single server. While Kamal makes this process straightforward, running multiple apps on shared hardware comes with an important consideration: resource management. You need to distribute CPU and memory wisely to ensure each application gets its fair share without starving others.</p> <h2 id="understanding-kamals-container-architecture">Understanding Kamalâ€™s Container Architecture</h2> <p>Kamal uses Docker under the hood, specifically the <code class="language-plaintext highlighter-rouge">docker run</code> command to manage containers. This means we can leverage Dockerâ€™s resource limitation options, but the configuration method differs between:</p> <ul> <li>Servers or Roles</li> <li>Accessory (like Redis, PostgreSQL)</li> <li>Proxy (Kamal Proxy)</li> </ul> <h2 id="setting-resource-limits-for-roles-and-accessories">Setting Resource Limits for Roles and Accessories</h2> <p>For your main application and accessories, add options key to your <code class="language-plaintext highlighter-rouge">deploy.yml</code>:</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/deploy.yml</span>

<span class="na">servers</span><span class="pi">:</span>
<span class="err">	</span><span class="na">host</span><span class="pi">:</span> <span class="s">HOST</span>
  <span class="s">options</span><span class="err">:</span>
    <span class="na">cpus</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>     <span class="c1"># Use 1 CPU core</span>
    <span class="na">memory</span><span class="pi">:</span> <span class="s">512M</span>  <span class="c1"># Limit memory to 512MB</span>

<span class="na">accessories</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">cpus</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0.5"</span>   <span class="c1"># Half a CPU core</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">256M</span>  <span class="c1"># 256MB memory limit</span>
</code></pre></div></div> <h2 id="setting-resource-limits-for-proxy">Setting Resource Limits for Proxy</h2> <p>The proxy container (Kamal proxy) requires a different approach. We need to use the Kamal CLI to set Docker options:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set CPU and memory limits for proxy</span>
kamal proxy boot_config <span class="nb">set</span> <span class="nt">--docker-options</span><span class="o">=</span><span class="s2">"cpus=0.5 memory=256M"</span>

<span class="c"># Verify current proxy settings</span>
kamal proxy boot_config get

<span class="c"># Restart the proxy to apply the changes</span>
kamal proxy reboot
</code></pre></div></div> <h2 id="pro-tips-">Pro Tips ðŸ’¡</h2> <ol> <li><strong>Monitor Before Setting</strong>: Deploy without limits first and monitor actual usage to set appropriate values.</li> <li><strong>Safety Buffer</strong>: Always add ~20% buffer to your observed memory usage and leave some headroom for the host system.</li> </ol> <hr /> <p>Need to learn more? Check out:</p> <ul> <li><a href="https://kamal-deploy.org/">Kamal Documentation</a></li> <li><a href="https://docs.docker.com/config/containers/resource_constraints/">Docker Resource Constraints</a></li> </ul> </div> <div class="grid grid-cols-2 text-sm"> <a class="prev" href="https://rslhdyt.dev/creating-custom-ufw-application-profiles/">&laquo; Creating Custom UFW Application Profiles</a> </div> <div class="related"> <h4 class="text-xl my-5">Related Posts</h4> <ul class="list-disc list-inside"> <li class="pl-8"> <a href="https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/">TIL: Handling Changes to Sidekiq Worker Class </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/real-time-webhook-updates-with-action-cable/">Real-time Webhook Updates with Action Cable </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/handling-incoming-webhooks-the-controller-layer/">Handling Incoming Webhooks: The Controller Layer </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/fix-dotenv-not-properly-setup-in-foreman/">Fix dotenv not properly setup in Foreman </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/navigating-docker-debugging-challenges-overriding-entrypoint/">Navigating Docker Debugging Challenges: Overriding ENTRYPOINT </a> </li> </ul> </div> <footer class="flex justify-center items-center border-solid border-0 border-t border-gray-200 p-10 mt-10"> Risal Hidayat Â© 2024 </footer> </div> </body> </html>
