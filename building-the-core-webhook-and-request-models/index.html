<!DOCTYPE html> <html lang="en" class="h-full"> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LTH48DE8D"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-2LTH48DE8D'); </script> <meta charset="utf-8"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=author content="Risal Hidayat"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Building the Core: Webhook and Request Models | Risal Hidayat</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Building the Core: Webhook and Request Models" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="After setting up the database structure, itâ€™s time to build the core models that power WebhookDump." /> <meta property="og:description" content="After setting up the database structure, itâ€™s time to build the core models that power WebhookDump." /> <link rel="canonical" href="https://rslhdyt.dev/building-the-core-webhook-and-request-models/" /> <meta property="og:url" content="https://rslhdyt.dev/building-the-core-webhook-and-request-models/" /> <meta property="og:site_name" content="Risal Hidayat" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-03-14T17:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Building the Core: Webhook and Request Models" /> <meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-03-14T17:00:00+00:00","datePublished":"2024-03-14T17:00:00+00:00","description":"After setting up the database structure, itâ€™s time to build the core models that power WebhookDump.","headline":"Building the Core: Webhook and Request Models","mainEntityOfPage":{"@type":"WebPage","@id":"https://rslhdyt.dev/building-the-core-webhook-and-request-models/"},"url":"https://rslhdyt.dev/building-the-core-webhook-and-request-models/"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon" sizes="180x180" href="https://rslhdyt.dev/assets/images/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="https://rslhdyt.dev/assets/images/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="https://rslhdyt.dev/assets/images/favicon/favicon-16x16.png"> <link rel="manifest" href="https://rslhdyt.dev/site.webmanifest"> <link rel="alternate" type="application/rss+xml" title="Risal Hidayat" href="https://rslhdyt.dev/feed.xml" /> <script src="https://kit.fontawesome.com/d9b09040a7.js" crossorigin="anonymous"></script> <!-- highlight.js --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css" integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script> <script>hljs.highlightAll();</script> <link rel="stylesheet" href="/assets/css/main.css"> </head> <body class="bg-zinc-50 flex h-full"> <div class="max-w-[600px] flex flex-col mx-auto w-11/12"> <nav class=" mt-7 md:mt-10 mb-10"> <ul class="flex flex-row justify-center space-x-6 text-l text-gray-500"> <li> <a href="https://rslhdyt.dev/">Home</a> </li> <li> <a href="https://rslhdyt.dev/blog">Blog</a> </li> <li class="item hidden sm:block"> <a href="https://rslhdyt.dev/code_snippet">Code Snippet</a> </li> <li> <a href="https://rslhdyt.dev/projects">Projects</a> </li> <li> <a href="https://rslhdyt.dev/about">About</a> </li> </ul> </nav> <h1 class="text-3xl text-center tracking-tight font-bold mb-5">Building the Core: Webhook and Request Models</h1> <span class="block text-center mb-5"> <time datetime="14-03-2024">Thursday. March 14, 2024</time> - <span class="reading-time" title="Estimated read time"> 3 mins read </span> </span> <div class="flex flex-row space-x-1.5 justify-center mb-10"> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/webhookdump">webhookdump</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/rails">rails</a> </div> <div class="posts"> <p>ðŸ’¡ See the code for this post on the ðŸ”— core-models branch.</p> <p>After creating our database structure in the previous chapter, itâ€™s time to add logic to our models. The models are the core of our application, handling data validation and relationships.</p> <h2 id="the-webhook-model">The Webhook Model</h2> <p>Letâ€™s start with the <code class="language-plaintext highlighter-rouge">Webhook</code> model. This model needs to:</p> <ul> <li>Generate a unique UUID for new webhooks</li> <li>Check if a webhook has expired</li> <li>Manage its relationship with webhook requests</li> </ul> <p>Hereâ€™s how I implemented these requirements:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Webhook</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:webhook_requests</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>

  <span class="n">validates</span> <span class="ss">:uuid</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:expired_at</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>

  <span class="n">before_validation</span> <span class="ss">:set_uuid</span><span class="p">,</span> <span class="ss">on: :create</span>

  <span class="k">def</span> <span class="nf">expired?</span>
    <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">to_date</span> <span class="o">&gt;</span> <span class="n">expired_at</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_uuid</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">uuid</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span> <span class="k">if</span> <span class="n">uuid</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div> <p>A few interesting things about this model:</p> <ol> <li>The <code class="language-plaintext highlighter-rouge">has_many</code> relationship tells Rails that one webhook can have multiple webhook requests</li> <li><code class="language-plaintext highlighter-rouge">dependent: :destroy</code> ensures all related webhook requests are deleted when we delete a webhook</li> <li>We use a <code class="language-plaintext highlighter-rouge">before_validation</code> callback to automatically set the UUID when creating a new webhook</li> <li>The <code class="language-plaintext highlighter-rouge">expired?</code> method helps us check if a webhook can still receive requests</li> </ol> <h2 id="the-webhookrequest-model">The WebhookRequest Model</h2> <p>Next, I built the <code class="language-plaintext highlighter-rouge">WebhookRequest</code> model to store incoming HTTP requests. This model needs to:</p> <ul> <li>Store all the details of an incoming request</li> <li>Belong to a webhook</li> </ul> <p>Hereâ€™s the implementation:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WebhookRequest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:webhook</span>

  <span class="c1"># Convert headers and query params to JSON before saving</span>
  <span class="n">before_save</span> <span class="ss">:ensure_json_format</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">ensure_json_format</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">.</span><span class="nf">to_json</span> <span class="k">unless</span> <span class="n">headers</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">String</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">query_params</span> <span class="o">=</span> <span class="n">query_params</span><span class="p">.</span><span class="nf">to_json</span> <span class="k">unless</span> <span class="n">query_params</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">String</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div> <p>The interesting parts of this model:</p> <ol> <li><code class="language-plaintext highlighter-rouge">belongs_to :webhook</code> sets up the relationship with the parent webhook</li> <li>We validate all fields because each piece of request information is important</li> <li>The <code class="language-plaintext highlighter-rouge">ensure_json_format</code> callback makes sure our headers and query parameters are stored as JSON strings</li> </ol> <h2 id="testing-the-models">Testing the Models</h2> <p>Letâ€™s test our models in the Rails console:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a new webhook that expires in 7 days</span>
<span class="n">webhook</span> <span class="o">=</span> <span class="no">Webhook</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">expired_at: </span><span class="mi">7</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">from_now</span><span class="p">)</span>

<span class="c1"># Create a webhook request</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">webhook</span><span class="p">.</span><span class="nf">webhook_requests</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
  <span class="ss">ip: </span><span class="s2">"127.0.0.1"</span><span class="p">,</span>
  <span class="ss">url: </span><span class="s2">"https://webhookdump.link/abc123"</span><span class="p">,</span>
  <span class="ss">method: </span><span class="s2">"POST"</span><span class="p">,</span>
  <span class="ss">host: </span><span class="s2">"webhookdump.link"</span><span class="p">,</span>
  <span class="ss">headers: </span><span class="p">{</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"application/json"</span><span class="p">},</span>
  <span class="ss">query_params: </span><span class="p">{</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"value"</span><span class="p">},</span>
  <span class="ss">payload: </span><span class="s1">'{"message": "Hello World"}'</span>
<span class="p">)</span>

<span class="c1"># Check if it worked</span>
<span class="nb">puts</span> <span class="s2">"Webhook UUID: </span><span class="si">#{</span><span class="n">webhook</span><span class="p">.</span><span class="nf">uuid</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"Request count: </span><span class="si">#{</span><span class="n">webhook</span><span class="p">.</span><span class="nf">webhook_requests</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="s2">"Is expired? </span><span class="si">#{</span><span class="n">webhook</span><span class="p">.</span><span class="nf">expired?</span><span class="si">}</span><span class="s2">"</span>

</code></pre></div></div> <p>With these models in place, our application can now:</p> <ol> <li>Create webhooks with unique identifiers</li> <li>Store incoming webhook requests with all their details</li> <li>Check if webhooks are still valid</li> <li>Maintain proper relationships between webhooks and their requests</li> </ol> <p>In the next chapter, weâ€™ll build the controllers to handle incoming webhook requests and display them to users.</p> <p>Stay tuned! ðŸš€</p> </div> <div class="grid grid-cols-2 text-sm"> <a class="prev" href="https://rslhdyt.dev/rails-disable-route-format/">&laquo; Rails Disable Route Format</a> <a class="next" href="https://rslhdyt.dev/navigating-docker-debugging-challenges-overriding-entrypoint/">Navigating Docker Debugging Challenges: Overriding ENTRYPOINT &raquo;</a> </div> <div class="related"> <h4 class="text-xl my-5">Related Posts</h4> <ul class="list-disc list-inside"> <li class="pl-8"> <a href="https://rslhdyt.dev/toctou-vs-dirty-read/">TOCTOU vs Dirty Read </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/setting-resource-limits-in-kamal-2/">Setting Resource Limits in Kamal 2 </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/">TIL: Handling Changes to Sidekiq Worker Class </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/real-time-webhook-updates-with-action-cable/">Real-time Webhook Updates with Action Cable </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/handling-incoming-webhooks-the-controller-layer/">Handling Incoming Webhooks: The Controller Layer </a> </li> </ul> </div> <footer class="flex justify-center items-center border-solid border-0 border-t border-gray-200 p-10 mt-10"> Risal Hidayat Â© 2025 </footer> </div> </body> </html>
