<!DOCTYPE html> <html lang="en" class="h-full"> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LTH48DE8D"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-2LTH48DE8D'); </script> <meta charset="utf-8"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=author content="Risal Hidayat"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>TOCTOU vs Dirty Read | Risal Hidayat</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="TOCTOU vs Dirty Read" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Technical interviews often reveal gaps in our understanding. During a recent interview with a Japanese company, I confidently explained a race condition issue as a “Dirty Read” problem – a term I’d been misusing for years. The interviewer’s follow-up questions led me to discover the real concept: TOCTOU (Time-of-Check to Time-of-Use). This interview not only corrected my misconception but reminded me why accepting interview opportunities is crucial for growth, even when you’re not job hunting." /> <meta property="og:description" content="Technical interviews often reveal gaps in our understanding. During a recent interview with a Japanese company, I confidently explained a race condition issue as a “Dirty Read” problem – a term I’d been misusing for years. The interviewer’s follow-up questions led me to discover the real concept: TOCTOU (Time-of-Check to Time-of-Use). This interview not only corrected my misconception but reminded me why accepting interview opportunities is crucial for growth, even when you’re not job hunting." /> <link rel="canonical" href="https://rslhdyt.dev/toctou-vs-dirty-read/" /> <meta property="og:url" content="https://rslhdyt.dev/toctou-vs-dirty-read/" /> <meta property="og:site_name" content="Risal Hidayat" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-09-29T17:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="TOCTOU vs Dirty Read" /> <meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-29T17:00:00+00:00","datePublished":"2025-09-29T17:00:00+00:00","description":"Technical interviews often reveal gaps in our understanding. During a recent interview with a Japanese company, I confidently explained a race condition issue as a “Dirty Read” problem – a term I’d been misusing for years. The interviewer’s follow-up questions led me to discover the real concept: TOCTOU (Time-of-Check to Time-of-Use). This interview not only corrected my misconception but reminded me why accepting interview opportunities is crucial for growth, even when you’re not job hunting.","headline":"TOCTOU vs Dirty Read","mainEntityOfPage":{"@type":"WebPage","@id":"https://rslhdyt.dev/toctou-vs-dirty-read/"},"url":"https://rslhdyt.dev/toctou-vs-dirty-read/"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon" sizes="180x180" href="https://rslhdyt.dev/assets/images/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="https://rslhdyt.dev/assets/images/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="https://rslhdyt.dev/assets/images/favicon/favicon-16x16.png"> <link rel="manifest" href="https://rslhdyt.dev/site.webmanifest"> <link rel="alternate" type="application/rss+xml" title="Risal Hidayat" href="https://rslhdyt.dev/feed.xml" /> <script src="https://kit.fontawesome.com/d9b09040a7.js" crossorigin="anonymous"></script> <!-- highlight.js --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css" integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script> <script>hljs.highlightAll();</script> <link rel="stylesheet" href="/assets/css/main.css"> </head> <body class="bg-zinc-50 flex h-full"> <div class="max-w-[600px] flex flex-col mx-auto w-11/12"> <nav class=" mt-7 md:mt-10 mb-10"> <ul class="flex flex-row justify-center space-x-6 text-l text-gray-500"> <li> <a href="https://rslhdyt.dev/">Home</a> </li> <li> <a href="https://rslhdyt.dev/blog">Blog</a> </li> <li class="item hidden sm:block"> <a href="https://rslhdyt.dev/code_snippet">Code Snippet</a> </li> <li> <a href="https://rslhdyt.dev/projects">Projects</a> </li> <li> <a href="https://rslhdyt.dev/about">About</a> </li> </ul> </nav> <h1 class="text-3xl text-center tracking-tight font-bold mb-5">TOCTOU vs Dirty Read</h1> <span class="block text-center mb-5"> <time datetime="29-09-2025">Monday. September 29, 2025</time> - <span class="reading-time" title="Estimated read time"> 6 mins read </span> </span> <div class="flex flex-row space-x-1.5 justify-center mb-10"> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/rails">rails</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/race-condition">race-condition</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/journey">journey</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/ruby">ruby</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/story">story</a> </div> <div class="posts"> <h2 id="the-interview">The Interview</h2> <p>Today is another reason and story to share about why I always encourage my fellow peers, subordinates, and friends to accept job offers and do as many job interviews as they can. Not only for the chance to get a new job, but in my opinion, the most important part are the experience the knowledge from the interview itself.</p> <p>Today, I had a technical interview session with a company from Japan. Before the interview, I had to complete a take-home test, and the interviewer asked about my code and decisions based on the project.</p> <p>The interviewer asked me to show my database design and asked some questions about the table design. To give you some perspective, let’s say I have this table schema:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># db/schema.rb</span>
<span class="n">create_table</span> <span class="s2">"follows"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"follower_id"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="s2">"followed_id"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"followed_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_follows_on_followed_id"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"follower_id"</span><span class="p">,</span> <span class="s2">"followed_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_follows_on_follower_id_and_followed_id"</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="p">[</span><span class="s2">"follower_id"</span><span class="p">],</span> <span class="ss">name: </span><span class="s2">"index_follows_on_follower_id"</span>
<span class="k">end</span>
</code></pre></div></div> <p>The interviewer asked: “Based on this database design, do you think it can handle when a user follows themselves?”</p> <p>I said no, but I already handle that in the application layer with ActiveRecord validation. Here’s the Follow model definition:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/follow.rb</span>
<span class="k">class</span> <span class="nc">Follow</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"User"</span>
  <span class="n">has_many</span> <span class="ss">:sleeps</span><span class="p">,</span> <span class="ss">through: :followed</span>

  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="p">{</span> <span class="ss">scope: :follower_id</span> <span class="p">}</span>
  <span class="n">validate</span> <span class="ss">:cannot_follow_self</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">cannot_follow_self</span>
    <span class="k">if</span> <span class="n">follower_id</span> <span class="o">==</span> <span class="n">followed_id</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:followed_id</span><span class="p">,</span> <span class="s2">"is the same as follower_id"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>As you can see, there’s a validation to prevent users from following themselves. And here’s where the interesting part begins. The interviewer asked:</p> <p><strong>Q: Do you think this ActiveRecord validation can handle race conditions?</strong></p> <p>My answer was No! But since we have the database constraint, it will prevent duplicate records from being inserted into the database. The interviewer asked a follow-up question:</p> <p><strong>Q: Why can’t the ActiveRecord validation handle race conditions? Can you explain?</strong></p> <p>I explained that it has a “Dirty Read” issue where two or more requests coming at the same time would cause ActiveRecord to perform validation by querying the follows table. Both requests would get the same result saying the record doesn’t exist in the database yet, and the validation would pass.</p> <p>The interview session ended and I was happy with my answers. Then came my learning moment.</p> <h2 id="today-i-learned">Today I Learned</h2> <p>After the interview, I tried to validate my answer by asking the same question to Claude and Google. Turns out my answer about the “Dirty Read” issue was not completely correct.</p> <p>The correct term for why ActiveRecord cannot handle race conditions is <strong>TOCTOU</strong>. What is TOCTOU? TOCTOU stands for Time-of-Check to Time-of-Use.</p> <p>Here’s what happens. I’m using an email validation example to make it simple:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The race condition scenario:</span>
<span class="c1"># Time T1: Request A checks if "user@example.com" exists -&gt; No, validation passes</span>
<span class="c1"># Time T2: Request B checks if "user@example.com" exists -&gt; No, validation passes</span>
<span class="c1"># Time T3: Request A saves the record -&gt; Success</span>
<span class="c1"># Time T4: Request B saves the record -&gt; Success (DUPLICATE!)</span>
</code></pre></div></div> <p>Rails uniqueness validation works in two steps:</p> <ol> <li><strong>SELECT</strong> query to check if the value exists</li> <li><strong>INSERT</strong> query to save the record</li> </ol> <p>Between these two steps, another process can insert the same value.</p> <p>Here’s reproducible code to simulate the race condition:</p> <p><strong>The User model:</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">maximum: </span><span class="mi">255</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong>The test script:</strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># race_condition_test.rb</span>
<span class="nb">require_relative</span> <span class="s1">'config/environment'</span>

<span class="n">email</span> <span class="o">=</span> <span class="s2">"race_</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span><span class="si">}</span><span class="s2">@example.com"</span>
<span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="c1"># Using spawn instead of fork since fork doesn't work on macOS</span>
  <span class="n">pids</span> <span class="o">&lt;&lt;</span> <span class="n">spawn</span><span class="p">(</span>
    <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"runner"</span><span class="p">,</span>
    <span class="s2">"User.create!(email: '</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">', name: 'Process </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">')"</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">pids</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">pid</span><span class="o">|</span> <span class="no">Process</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">}</span>
<span class="nb">puts</span> <span class="s2">"Total users with that email: </span><span class="si">#{</span><span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">).</span><span class="nf">count</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div></div> <p><strong>The result:</strong></p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total users with that email: 5
</code></pre></div></div> <p>Five duplicate records despite our uniqueness validation!</p> <h2 id="toctou-vs-dirty-read-understanding-the-difference">TOCTOU vs Dirty Read: Understanding the Difference</h2> <p>So what’s the difference between TOCTOU and Dirty Read? Here’s the explanation by Claude 😃</p> <p><strong>Dirty Read</strong> is a transaction isolation problem where one transaction reads uncommitted changes made by another transaction.</p> <p><strong>TOCTOU</strong> is a race condition where the state changes between checking a condition and acting on it.</p> <h3 id="side-by-side-comparison">Side-by-Side Comparison</h3> <table> <thead> <tr> <th>Aspect</th> <th>Dirty Read</th> <th>TOCTOU</th> </tr> </thead> <tbody> <tr> <td><strong>What’s the problem?</strong></td> <td>Reading uncommitted data</td> <td>State changes between check and use</td> </tr> <tr> <td><strong>Transaction related?</strong></td> <td>Yes, crosses transaction boundaries</td> <td>No, can happen in single transaction</td> </tr> <tr> <td><strong>Data validity</strong></td> <td>Data may never exist (rollback case)</td> <td>Data is real and committed</td> </tr> <tr> <td><strong>When it occurs</strong></td> <td>During concurrent transactions</td> <td>Between sequential operations</td> </tr> <tr> <td><strong>Prevention</strong></td> <td>Transaction isolation level</td> <td>Atomic operations, locks, or constraints</td> </tr> <tr> <td><strong>Database can prevent it?</strong></td> <td>Yes (Read Committed)</td> <td>No (needs application logic)</td> </tr> </tbody> </table> <h2 id="the-lesson-learned">The Lesson Learned</h2> <p>This interview taught me something valuable. I thought I understood race conditions, but I was mixing up different concepts. TOCTOU and Dirty Reads are both concurrency problems, but they’re completely different beasts.</p> <p>The key takeaways from this experience:</p> <ul> <li><strong>ActiveRecord validations are not enough</strong> - they can’t prevent race conditions</li> <li><strong>Database constraints are your best friend</strong> - let the database do what it does best</li> <li><strong>Know your terminology</strong> - understanding the difference between TOCTOU and Dirty Read helps you solve the right problem</li> <li><strong>Test with real concurrency</strong> - don’t just test sequential operations</li> <li><strong>Handle errors gracefully</strong> - your users shouldn’t see database constraint errors</li> </ul> <p>Most importantly, this is why I love technical interviews. Even when you think you know something, there’s always more to learn. Sometimes you need someone to ask the right question to realize you’ve been using the wrong term for years.</p> <p>Next time someone asks you about race conditions, you’ll know exactly what’s happening under the hood. And more importantly, you’ll know how to fix it properly.</p> </div> <div class="grid grid-cols-2 text-sm"> <a class="prev" href="https://rslhdyt.dev/why-code-review-skills-matter-more-than-ever-in-the-age-of-ai-coding/">&laquo; Why Code Review Skills Matter More Than Ever in the Age of AI Coding</a> </div> <div class="related"> <h4 class="text-xl my-5">Related Posts</h4> <ul class="list-disc list-inside"> <li class="pl-8"> <a href="https://rslhdyt.dev/why-code-review-skills-matter-more-than-ever-in-the-age-of-ai-coding/">Why Code Review Skills Matter More Than Ever in the Age of AI Coding </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/demi-neptunus/">Demi Neptunus!!! </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/setting-resource-limits-in-kamal-2/">Setting Resource Limits in Kamal 2 </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/">TIL: Handling Changes to Sidekiq Worker Class </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/real-time-webhook-updates-with-action-cable/">Real-time Webhook Updates with Action Cable </a> </li> </ul> </div> <footer class="flex justify-center items-center border-solid border-0 border-t border-gray-200 p-10 mt-10"> Risal Hidayat © 2025 </footer> </div> </body> </html>
