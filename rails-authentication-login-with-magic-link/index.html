<!DOCTYPE html> <html lang="en" class="h-full"> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LTH48DE8D"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-2LTH48DE8D'); </script> <meta charset="utf-8"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=author content="Risal Hidayat"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Rails Authentication Login with magic link | Risal Hidayat</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Rails Authentication Login with magic link" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Magic link authentication is a method of logging into a website or application without the need for a password." /> <meta property="og:description" content="Magic link authentication is a method of logging into a website or application without the need for a password." /> <link rel="canonical" href="https://rslhdyt.dev/rails-authentication-login-with-magic-link/" /> <meta property="og:url" content="https://rslhdyt.dev/rails-authentication-login-with-magic-link/" /> <meta property="og:site_name" content="Risal Hidayat" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2023-11-12T17:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Rails Authentication Login with magic link" /> <meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-12T17:00:00+00:00","datePublished":"2023-11-12T17:00:00+00:00","description":"Magic link authentication is a method of logging into a website or application without the need for a password.","headline":"Rails Authentication Login with magic link","mainEntityOfPage":{"@type":"WebPage","@id":"https://rslhdyt.dev/rails-authentication-login-with-magic-link/"},"url":"https://rslhdyt.dev/rails-authentication-login-with-magic-link/"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon" sizes="180x180" href="https://rslhdyt.dev/assets/images/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="https://rslhdyt.dev/assets/images/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="https://rslhdyt.dev/assets/images/favicon/favicon-16x16.png"> <link rel="manifest" href="https://rslhdyt.dev/site.webmanifest"> <link rel="alternate" type="application/rss+xml" title="Risal Hidayat" href="https://rslhdyt.dev/feed.xml" /> <script src="https://kit.fontawesome.com/d9b09040a7.js" crossorigin="anonymous"></script> <!-- highlight.js --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css" integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script> <script>hljs.highlightAll();</script> <link rel="stylesheet" href="/assets/css/main.css"> </head> <body class="bg-zinc-50 flex h-full"> <div class="max-w-[600px] flex flex-col mx-auto w-11/12"> <nav class=" mt-7 md:mt-10 mb-10"> <ul class="flex flex-row justify-center space-x-6 text-l text-gray-500"> <li> <a href="https://rslhdyt.dev/">Home</a> </li> <li> <a href="https://rslhdyt.dev/blog">Blog</a> </li> <li class="item hidden sm:block"> <a href="https://rslhdyt.dev/code_snippet">Code Snippet</a> </li> <li> <a href="https://rslhdyt.dev/projects">Projects</a> </li> <li> <a href="https://rslhdyt.dev/about">About</a> </li> </ul> </nav> <h1 class="text-3xl text-center tracking-tight font-bold mb-5">Rails Authentication Login with magic link</h1> <span class="block text-center mb-5"> <time datetime="12-11-2023">Sunday. November 12, 2023</time> - <span class="reading-time" title="Estimated read time"> 6 mins read </span> </span> <div class="flex flex-row space-x-1.5 justify-center mb-10"> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/rails">rails</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/authentication">authentication</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/tutorial">tutorial</a> </div> <div class="posts"> <p><img src="https://images.unsplash.com/photo-1496449903678-68ddcb189a24?ixlib=rb-4.0.3&amp;q=85&amp;fm=jpg&amp;crop=entropy&amp;cs=srgb" alt="" /></p> <p><em>Photo by <a href="https://unsplash.com/@austinchan">Austinchan</a> / <a href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit">Unsplash</a></em></p> <h1 id="introduction">Introduction</h1> <p>When it comes to letting people into an app, there are different ways to check if they’re the real users. One way is to use something called a ‘magic link.’ This article explains how to make a login system with a magic link in a Rails app. It’ll show you how to set it up and why it can be a good idea.</p> <h2 id="about-magic-link">About magic link</h2> <p>Magic link authentication is a method of logging into a website or application without the need for a password. It relies on the use of a unique URL, also known as a magic link, which is sent to the user’s registered email address or phone number. The user can then click on this link to authenticate their identity and gain access to their account.</p> <h2 id="how-it-works">How it works?</h2> <p>Typically, the user only needs to enter their email on the authentication page. Next, the application checks whether the email exists. If the email exists, the application sends a signed URL to the user’s email. The user then clicks on the link and gets redirected to our application. Finally, the application checks the link’s validity before authenticating the user.</p> <h2 id="how-to-implement">How to implement</h2> <p>To implement the login using magic link you need to do these things:</p> <ol> <li>Controller to generate magic link and handle login with link</li> <li>Mailer that will send out the magic link</li> </ol> <h3 id="create-controller-handler">Create controller handler</h3> <p>I will name my controller <code class="language-plaintext highlighter-rouge">sign_in_links_controller.rb</code> and add route like this</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SignInLinksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">authenticate</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s1">'sign_in/link'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sign_in_links#new'</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'new_sign_in_link'</span>
<span class="n">post</span> <span class="s1">'sign_in/link'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sign_in_links#create'</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'sign_in_links'</span>
<span class="n">get</span> <span class="s1">'sign_in/authenticate/:token'</span><span class="p">,</span> <span class="ss">to: </span><span class="s1">'sign_in_links#authenticate'</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'authenticate_sign_in_links'</span>
</code></pre></div></div> <h3 id="create-login-with-link-view">Create login with link view</h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre></div></div> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Log</span> <span class="k">in</span> <span class="n">with</span> <span class="n">magic</span> <span class="n">link</span><span class="o">&lt;</span><span class="sr">/h2&gt;

&lt;%= form_with(model: @user, url: sign_in_links_path) do |f| %&gt;
  &lt;div class="field"&gt;
    &lt;%= f.label :email %&gt;
    &lt;%= f.email_field :email, autofocus: true, autocomplete: "email" %&gt;
  &lt;/</span><span class="n">div</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">div</span> <span class="k">class</span><span class="o">=</span><span class="s2">"actions"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="sx">%= f.submit "Send Magic Link" %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</span></code></pre></div></div> <h3 id="generate-magic-link">Generate magic link</h3> <p>Inside the new controller, you need to create an action to generate the magic link</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">params</span><span class="p">[</span><span class="ss">:user</span><span class="p">][</span><span class="ss">:email</span><span class="p">])</span>

  <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">present?</span>
    <span class="n">token</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">signed_id</span><span class="p">(</span><span class="ss">expires_in: </span><span class="mi">2</span><span class="p">.</span><span class="nf">minutes</span><span class="p">,</span> <span class="ss">purpose: :magic_link</span><span class="p">)</span>

    <span class="c1"># send email</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">magic_link</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">deliver_later</span>

    <span class="n">redirect_to</span> <span class="n">new_user_session_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s1">'A temporary login code has been sent to your inbox. Please check it.'</span>
  <span class="k">else</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Email address not found.'</span>

    <span class="n">render</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">status: :unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>As you can see above, there are 3 steps to generate the login with magic link.</p> <ol> <li>Check the user email existence</li> <li>Generate signed URL token</li> <li>Send the magic link via mailer</li> </ol> <p>Rails 6 introduced <code class="language-plaintext highlighter-rouge">signed_id</code> method and we can utilize this method to generate authenticate token.</p> <blockquote> <p>signed_id method returns a signed id that’s generated using a preconfigured <code class="language-plaintext highlighter-rouge">ActiveSupport::MessageVerifier</code> instance. This signed id is tamper proof, so it’s safe to send in an email or otherwise share with the outside world. It can furthermore be set to expire (the default is not to expire), and scoped down with a specific purpose. If the expiration date has been exceeded before <code class="language-plaintext highlighter-rouge">find_signed</code> is called, the id won’t find the designated record. If a purpose is set, this too must match.</p> </blockquote> <p><a href="https://api.rubyonrails.org/classes/ActiveRecord/SignedId.html#method-i-signed_id">https://api.rubyonrails.org/classes/ActiveRecord/SignedId.html#method-i-signed_id</a></p> <p>The signed_id method accept 2 optional params</p> <ol> <li>expires_in To set the expiration of the signed ID</li> <li>purpose To set the name or purpose of signed ID generation</li> </ol> <h3 id="login-link-handler">Login link handler</h3> <p>Still at the same controller, you need to create a method for handling the authentication.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">authenticate</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_signed</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:token</span><span class="p">],</span> <span class="ss">purpose: :magic_link</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">present?</span>
    <span class="n">sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>

    <span class="n">flash</span><span class="p">[</span><span class="ss">:success</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'You have successfully logged in.'</span>

    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">else</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:info</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Link invalid or expired. Please try again.'</span>

    <span class="c1"># redirect to login page</span>
    <span class="n">redirect_to</span> <span class="n">new_user_session_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>By using <code class="language-plaintext highlighter-rouge">find_signed</code> method, we can check whether the token is valid or not.</p> <p><a href="https://api.rubyonrails.org/classes/ActiveRecord/SignedId/ClassMethods.html#method-i-find_signed">https://api.rubyonrails.org/classes/ActiveRecord/SignedId/ClassMethods.html#method-i-find_signed</a></p> <h3 id="mailer-to-send-the-magic">Mailer to send the magic</h3> <p>Lastly, we need to create the Mailer class to send the magic link to the user. I will put the mailer method inside the <code class="language-plaintext highlighter-rouge">UserMailer</code>.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">magic_link</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="vi">@token</span> <span class="o">=</span> <span class="n">token</span>

    <span class="n">mail</span><span class="p">(</span>
      <span class="ss">to: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
      <span class="ss">subject: </span><span class="s1">'Magic link to sign in'</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>And here is the view</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Hi</span><span class="o">!&lt;</span><span class="sr">/h2&gt;
&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">Dear</span> <span class="o">&lt;</span><span class="sx">%= @user.name %&gt;,&lt;/p&gt;
  &lt;p&gt;Click the link below to log in:&lt;/p&gt;
  &lt;%=</span> <span class="n">link_to</span> <span class="s1">'Login with link'</span><span class="p">,</span> <span class="n">authenticate_sign_in_links_url</span><span class="p">(</span><span class="ss">token: </span><span class="vi">@token</span><span class="p">)</span> <span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">This</span> <span class="n">link</span> <span class="n">will</span> <span class="n">expire</span> <span class="k">in</span> <span class="mi">2</span> <span class="n">minutes</span><span class="p">.</span><span class="nf">&lt;</span><span class="o">/</span><span class="nb">p</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="no">If</span> <span class="n">you</span> <span class="n">did</span> <span class="n">not</span> <span class="n">request</span> <span class="n">this</span> <span class="n">login</span> <span class="n">link</span><span class="p">,</span> <span class="n">please</span> <span class="n">ignore</span> <span class="n">this</span> <span class="n">email</span><span class="p">.</span><span class="nf">&lt;</span><span class="o">/</span><span class="nb">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;
</span></code></pre></div></div> <p>Congratulations! You’ve successfully integrated magic links into your application with only a few lines of code, eliminating the need for any external libraries.</p> </div> <div class="grid grid-cols-2 text-sm"> <a class="prev" href="https://rslhdyt.dev/race-conditions-in-ruby-what-they-are-and-how-to-avoid-them/">&laquo; Race conditions in Ruby what they are and how to avoid them</a> <a class="next" href="https://rslhdyt.dev/flipper-retrieve-a-list-of-features-for-an-actor/">Flipper: Retrieve a List of Features for an Actor &raquo;</a> </div> <div class="related"> <h4 class="text-xl my-5">Related Posts</h4> <ul class="list-disc list-inside"> <li class="pl-8"> <a href="https://rslhdyt.dev/fix-dotenv-not-properly-setup-in-foreman/">Fix dotenv not properly setup in Foreman </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/webhookdump-database-design/">WebhookDump: Database Design </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/streamline-your-sidekiq-cron-jobs-with-a-single-worker-class-for-rake-task-invocation/">Streamline Your Sidekiq Cron Jobs with a Single Worker Class for Rake Task Invocation </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/setting-up-a-rails-project-for-webhookdump/">Setting Up a Rails Project for Webhookdump </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/how-to-create-a-copy-to-clipboard-action-in-stimulus/">How to Create a Copy-to-Clipboard Action in Stimulus </a> </li> </ul> </div> <footer class="flex justify-center items-center border-solid border-0 border-t border-gray-200 p-10 mt-10"> Risal Hidayat © 2024 </footer> </div> </body> </html>
