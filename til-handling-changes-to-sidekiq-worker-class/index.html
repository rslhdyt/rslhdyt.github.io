<!DOCTYPE html> <html lang="en" class="h-full"> <head> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LTH48DE8D"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-2LTH48DE8D'); </script> <meta charset="utf-8"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name=author content="Risal Hidayat"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>TIL: Handling Changes to Sidekiq Worker Class | Risal Hidayat</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="TIL: Handling Changes to Sidekiq Worker Class" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Today I learned a valuable lesson about the intricacies of modifying Sidekiq worker classes in our Ruby on Rails application. What started as a routine code deployment turned into an unexpected adventure, revealing the hidden complexities of Sidekiq’s job persistence mechanism." /> <meta property="og:description" content="Today I learned a valuable lesson about the intricacies of modifying Sidekiq worker classes in our Ruby on Rails application. What started as a routine code deployment turned into an unexpected adventure, revealing the hidden complexities of Sidekiq’s job persistence mechanism." /> <link rel="canonical" href="https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/" /> <meta property="og:url" content="https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/" /> <meta property="og:site_name" content="Risal Hidayat" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-05-14T17:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="TIL: Handling Changes to Sidekiq Worker Class" /> <meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-14T17:00:00+00:00","datePublished":"2024-05-14T17:00:00+00:00","description":"Today I learned a valuable lesson about the intricacies of modifying Sidekiq worker classes in our Ruby on Rails application. What started as a routine code deployment turned into an unexpected adventure, revealing the hidden complexities of Sidekiq’s job persistence mechanism.","headline":"TIL: Handling Changes to Sidekiq Worker Class","mainEntityOfPage":{"@type":"WebPage","@id":"https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/"},"url":"https://rslhdyt.dev/til-handling-changes-to-sidekiq-worker-class/"}</script> <!-- End Jekyll SEO tag --> <link rel="apple-touch-icon" sizes="180x180" href="https://rslhdyt.dev/assets/images/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="https://rslhdyt.dev/assets/images/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="https://rslhdyt.dev/assets/images/favicon/favicon-16x16.png"> <link rel="manifest" href="https://rslhdyt.dev/site.webmanifest"> <link rel="alternate" type="application/rss+xml" title="Risal Hidayat" href="https://rslhdyt.dev/feed.xml" /> <script src="https://kit.fontawesome.com/d9b09040a7.js" crossorigin="anonymous"></script> <!-- highlight.js --> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css" integrity="sha512-Vj6gPCk8EZlqnoveEyuGyYaWZ1+jyjMPg8g4shwyyNlRQl6d3L9At02ZHQr5K6s5duZl/+YKMnM3/8pDhoUphg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script> <script>hljs.highlightAll();</script> <link rel="stylesheet" href="/assets/css/main.css"> </head> <body class="bg-zinc-50 flex h-full"> <div class="max-w-[600px] flex flex-col mx-auto w-11/12"> <nav class=" mt-7 md:mt-10 mb-10"> <ul class="flex flex-row justify-center space-x-6 text-l text-gray-500"> <li> <a href="https://rslhdyt.dev/">Home</a> </li> <li> <a href="https://rslhdyt.dev/blog">Blog</a> </li> <li class="item hidden sm:block"> <a href="https://rslhdyt.dev/code_snippet">Code Snippet</a> </li> <li> <a href="https://rslhdyt.dev/projects">Projects</a> </li> <li> <a href="https://rslhdyt.dev/about">About</a> </li> </ul> </nav> <h1 class="text-3xl text-center tracking-tight font-bold mb-5">TIL: Handling Changes to Sidekiq Worker Class</h1> <span class="block text-center mb-5"> <time datetime="14-05-2024">Tuesday. May 14, 2024</time> - <span class="reading-time" title="Estimated read time"> 6 mins read </span> </span> <div class="flex flex-row space-x-1.5 justify-center mb-10"> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/rails">rails</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/sidekiq">sidekiq</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/sidekiq-cron">sidekiq-cron</a> <a class="bg-gray-200 px-2 rounded-sm font-thin" href="https://rslhdyt.dev/tags/til">TIL</a> </div> <div class="posts"> <p>This articles documents two related issues encountered by Sidekiq workers during my recent code deployments to the production environment. Both issues highlight the importance of understanding Sidekiq’s behavior when modifying worker classes or their arguments.</p> <p>The first issue involved the removal of a scheduled Sidekiq worker class, while the second issue pertained to modifying the arguments accepted by a worker class. In both cases, errors occurred due to Sidekiq’s handling of existing jobs in the queue.</p> <p>The report aims to analyze the root causes of these issues, outline the remediation steps taken, and propose preventive measures to avoid similar occurrences in the future. Additionally, it summarizes the key lessons learned to improve the team’s development practices and ensure a more robust Sidekiq implementation.</p> <h2 id="problem-statement">Problem Statement</h2> <p>As mentioned in the introduction, this report covers two different cases but with the same behavior.</p> <ol> <li>The deleted sidekiq cron scheduler still exists in the cron scheduler list We have a sidekiq worker class called ResetDocQuotaWorker. That worker class is responsible for calculating and resetting user document quota. The worker running daily at 00:00 UTC timezone time. There were reports that some user document quotas were not running as expected, and after checking with the engineer, we found the issue that the data processed by the worker was too big and needed refactoring.</li> </ol> <p>The engineer split the worker into several classes to make the data smaller and chunked into separate groups of subscription types. So the new classes are ResetFreeDocQuotaWorker and ResetPaidDocQuotaWorker. Therefore the old class ResetDocQuotaWorker was removed from the schedule.yml</p> <p>After the changes were deployed to production, the new worker appeared in the sidekiq-cron list scheduler. However, the old class ResetDocQuotaWorker still exists and running as usual, causing an error in our monitoring report.</p> <ol> <li>The worker class stopped working after the class argument changed The next involved the SignGlobalWorker class. The error was raised due to the sidekiq worker job failing to fetch the parameters from the class. Upon checking the root cause there is a change in the arguments of SignGlobalWorker. Previously, the class accepted 4 arguments, user_id, envelope_id, signature, initial. And there is a need to add 1 more argument signature_id to support business needs. However, the rubocop said that the 5 arguments on a single method violated the rule. Thus, the engineer decided to refactor the argument into a hash containing the keys and the values of the param.</li> </ol> <h3 id="root-cause-analysis">Root Cause Analysis</h3> <p>Both issues in the previous problem statement section have the same behavior. Which was the sidekiq job client still processing the old behavior before the changes. The root of the problem is that Sidekiq persists jobs in Redis, and it doesn’t automatically update or remove these persisted jobs when you make changes to your worker classes or schedule file. Here are the detailed explanations of both problems.</p> <ol> <li><strong>Removing a worker class from the schedule file</strong>: When you remove a worker class from the schedule.yml file, Sidekiq doesn’t automatically remove the scheduled instances of that job. This is because Sidekiq persists in scheduled jobs in Redis, and it doesn’t check for removed jobs in the schedule file. It only schedules new jobs that it finds in the file. So, even if you remove a job from the schedule.yml file, the previously scheduled instances of that job will still exist in Redis and will be executed at their scheduled times.</li> <li><strong>Changing the arguments of a worker class</strong>: When you enqueue a job in Sidekiq, it serializes the job’s class name and arguments and stores them in Redis. When it’s time to execute the job, Sidekiq fetches the job from Redis, deserializes it, and calls the perform method on the job’s class with the deserialized arguments. If you change the arguments that the perform method expects (for example, from four arguments to a single hash), but there are still jobs in Redis that were enqueued with the old arguments, Sidekiq will try to call the perform method with the old arguments, causing an ArgumentError.</li> </ol> <h3 id="remediation-steps">Remediation Steps</h3> <p>This section tries to explain how we should handle the changes in the sidekiq worker.</p> <h3 id="handling-deletion-of-existing-sidekiq-cron-schedule">Handling deletion of existing sidekiq-cron schedule</h3> <p>If you need to remove the existing sidekiq cron schedule class follow these steps:</p> <ol> <li>Disable instead remove the config Sidekiq cron job properties support optional properties for toggling to enable or disable scheduled jobs. The key name is status with the value disabled or enabled, the default value is enabled.</li> </ol> <p>So instead of removing the job from the schedule.yml we can disable the job by setting the job status to disabled. This setup prevents the scheduled job from running after the changes are deployed to the server.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  # MANDATORY
  'name' =&gt; 'name_of_job', # must be uniq!
  'cron' =&gt; '1 * * * *',  # execute at 1 minute of every hour, ex: 12:01, 13:01, 14:01
  ...
  'class' =&gt; 'MyClass',
  # OPTIONAL
  ...
  'status' =&gt; 'disabled'
}
</code></pre></div></div> <ol> <li>Remove the job via the Rails console After the changes were deployed to production and no major issue was raised. We can delete the old job by executing the below command.</li> </ol> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">job</span> <span class="o">=</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Cron</span><span class="o">::</span><span class="no">Job</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="s1">'name_of_the_job'</span><span class="p">)</span>
<span class="c1"># example: Sidekiq::Cron::Job.find('reset_doc_quota_worker')</span>

<span class="c1"># Remove the job</span>
<span class="n">job</span><span class="p">.</span><span class="nf">destroy</span> <span class="k">if</span> <span class="n">job</span>
</code></pre></div></div> <h3 id="handling-sidekiq-worker-argument-changes">Handling sidekiq worker argument changes</h3> <p>This one is a bit tricky, but the rule of thumb is that the sidekiq worker changes should be backward compatible. It means that the latest changes to the existing worker should not affect the previous version of the worker and vice versa.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">BulkSigns</span>
  <span class="k">class</span> <span class="nc">SignGlobalWorker</span>
    <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>

    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">envelope_id</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
      <span class="c1"># do something</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>As you can see in the previous code snippet, the SignGlobalWorker class accepts 4 arguments. So if you need to update or add more arguments follow these rules.</p> <ol> <li><strong>Do not change</strong> the order of the existing arguments <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❌
def perform(user_id, signature, envelope_id, initial)
  # do something
end
</code></pre></div> </div> </li> <li><strong>Do not remove</strong> the existing arguments <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❌
def perform(user_id, envelope_id, initial)
  # do something
end
</code></pre></div> </div> </li> <li><strong>Add default value</strong> for a newly added argument <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✅
def perform(user_id, envelope_id, initial, signature, signature_id = nil)
  # do something
end
</code></pre></div> </div> </li> </ol> <p>If the refactoring is inevitable, you can consider creating a new worker class instead of modifying the existing one. This option will prevent the ArgumentError from being raised because the old worker will process existing parameters from Redis and eventually stop running. After all, no new job is dispatched to the old job.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module Fruit
  module V2
    class BananaWorker
      include Sidekiq::Worker

      def perform(params)
        # do something
      end
    end
  end
end

Fruit::V2::BananaWorker.perform_async({
  user_id: USER_ID,
  envelope_id: ENVELOPE_ID,
  initial: INITIAL,
  signature: SIGNATURE,
  signature_id: SIGNATURE_ID
})
</code></pre></div></div> <h2 id="summary">Summary</h2> <p>The issues documented in this report highlight the importance of understanding Sidekiq’s behavior and taking necessary precautions when modifying worker classes or their arguments. <strong>Failure to do so can lead to errors, job failures, and potential data inconsistencies or loss.</strong></p> <p>The root cause analysis revealed that Sidekiq persists jobs in Redis and does not automatically update or remove these persisted jobs when changes are made to worker classes or the schedule file. This behavior can cause issues when removing scheduled worker classes or modifying the arguments of existing worker classes.</p> <p>Adhering to these principles will maintain a robust and reliable Sidekiq implementation for efficient background job processing.</p> </div> <div class="grid grid-cols-2 text-sm"> <a class="prev" href="https://rslhdyt.dev/fix-dotenv-not-properly-setup-in-foreman/">&laquo; Fix dotenv not properly setup in Foreman</a> <a class="next" href="https://rslhdyt.dev/creating-custom-ufw-application-profiles/">Creating Custom UFW Application Profiles &raquo;</a> </div> <div class="related"> <h4 class="text-xl my-5">Related Posts</h4> <ul class="list-disc list-inside"> <li class="pl-8"> <a href="https://rslhdyt.dev/fix-dotenv-not-properly-setup-in-foreman/">Fix dotenv not properly setup in Foreman </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/rails-disable-route-format/">Rails Disable Route Format </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/webhookdump-database-design/">WebhookDump: Database Design </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/streamline-your-sidekiq-cron-jobs-with-a-single-worker-class-for-rake-task-invocation/">Streamline Your Sidekiq Cron Jobs with a Single Worker Class for Rake Task Invocation </a> </li> <li class="pl-8"> <a href="https://rslhdyt.dev/setting-up-a-rails-project-for-webhookdump/">Setting Up a Rails Project for Webhookdump </a> </li> </ul> </div> <footer class="flex justify-center items-center border-solid border-0 border-t border-gray-200 p-10 mt-10"> Risal Hidayat © 2024 </footer> </div> </body> </html>
